version: 1
runtime: python3
build:
  commands:
    - echo "ğŸš€ Building FastAPI Production Application"
    - echo "ğŸ“¦ Installing dependencies"
    - pip install -r requirements.txt
    - echo "ğŸ”§ Setting up production environment"
    - echo "ğŸ—„ï¸ Initializing SQLite database for production"
    - python -c "
from app.database import engine
from app.models import Base
Base.metadata.create_all(bind=engine)
print('âœ… Database tables created')
"
    - echo "ğŸ‘¤ Creating admin user"
    - python -c "
from app.database import get_db
from app.auth import create_user, UserCreate, UserRole, get_user_by_username
db = next(get_db())
if not get_user_by_username(db, 'admin'):
    from app.auth import UserCreate, UserRole
    admin = UserCreate(
        username='admin',
        email='admin@delivery-platform.com', 
        password='admin123',
        role=UserRole.ADMIN,
        full_name='System Administrator'
    )
    create_user(db, admin)
    print('âœ… Admin user created')
else:
    print('âœ… Admin user already exists')
db.close()
"
    - echo "âœ… Production build complete"
run:
  runtime-version: python3.11
  commands:
    - python start_production.py
  network:
    port: 8080
    env: PORT
  env:
    - name: ENVIRONMENT
      value: production
    - name: DATABASE_URL
      value: sqlite:///./delivery_platform.db
    - name: SECRET_KEY
      value: prod-4a7d8c9e2f1b5a8c3d6e9f2a5b8c1d4e7a0b3c6d9e2f5a8b1c4d7e0a3b6c9d2e5f8a1b4c7d0
