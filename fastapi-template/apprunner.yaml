version: 1
runtime: python3
build:
  commands:
    - echo "üöÄ Building FastAPI Production Application"
    - echo "üì¶ Installing dependencies"
    - pip install -r requirements.txt
    - echo "üîß Setting up production environment"
    - cp .env.production .env
    - echo "üóÑÔ∏è Initializing RDS PostgreSQL database"
    - python -c "
from app.database import engine
from app.models import Base
try:
    Base.metadata.create_all(bind=engine)
    print('‚úÖ Database tables created successfully')
except Exception as e:
    print(f'Database setup: {e}')
    "
    - echo "üë§ Creating admin user in production database"
    - python -c "
from app.database import get_db
from app.auth import create_user, UserCreate, UserRole, get_user_by_username
try:
    db = next(get_db())
    if not get_user_by_username(db, 'admin'):
        admin = UserCreate(
            username='admin',
            email='admin@delivery-platform.com', 
            password='admin123',
            role=UserRole.ADMIN,
            full_name='System Administrator'
        )
        create_user(db, admin)
        print('‚úÖ Admin user created')
    else:
        print('‚úÖ Admin user already exists')
    db.close()
except Exception as e:
    print(f'Admin setup: {e}')
    "
    - echo "‚úÖ Production build complete"
run:
  runtime-version: python3.11
  commands:
    - python start_production.py
  network:
    port: 8080
    env: PORT
  env:
    - name: ENVIRONMENT
      value: production
    - name: RDS_ENDPOINT
      value: delivery-platform-db.clo2o2squsbf.eu-north-1.rds.amazonaws.com
    - name: RDS_PORT
      value: "5432"
    - name: RDS_DB_NAME
      value: delivery_platform
    - name: RDS_USERNAME
      value: ghayth
    - name: RDS_PASSWORD
      value: DeliveryPlatform2025!
    - name: SECRET_KEY
      value: prod-4a7d8c9e2f1b5a8c3d6e9f2a5b8c1d4e7a0b3c6d9e2f5a8b1c4d7e0a3b6c9d2e5f8a1b4c7d0
